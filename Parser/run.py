#!/bin/env python3
# -*- coding: utf-8 -*-

import argparse  # https://docs.python.org/3/library/argparse.html
import configparser
import os
from timeit import default_timer as timer

from compatible import Compatible
from completeSessions import CompleteSession
from parser import Parser
from utils.functions import get_logger

config = configparser.ConfigParser()
config.sections()
config.read('settings.conf')


def create_arg_parser() -> argparse:
    """
    Metodo para establecer los argumentos que necesita la clasek

    :return:
    """
    example = "python3 %(prog)s -d /mnt/cowrie/log/ -o output/ -v"

    my_parser = argparse.ArgumentParser(description='%(prog)s is a script to parse the log generated by the honeypot\ '
     'SSH Cowrie and generate a JSON file with which to import the data into a BD NoSQL.', usage='{}'.format(example))

    required_named = my_parser.add_argument_group('required named arguments')
    required_named.add_argument('-d', '--dir', help='Directory where the files are located.')
    my_parser.add_argument('-o', '--output', help='Directory where the generated files are stored.')
    my_parser.add_argument('-db', '--mmdb', help='Path where the DB is in our SO.')
    my_parser.add_argument('-v', '--verbose', action='store_true', help='Verbose flag (boolean).', default=False)

    # se puede poner en la misma linea
    my_parser.set_defaults(mmdb=config['DEFAULTS']['BD_GEOIP2'])
    my_parser.set_defaults(output=config['DEFAULTS']['OUTPUT'])
    # my_parser.print_help()
    return my_parser.parse_args()


if __name__ == "__main__":
    arg = create_arg_parser()

    if os.path.exists('{}/{}'.format(arg.output, config['DEFAULTS']['FILE_LOG_COWRIE'])):
        os.remove('{}/{}'.format(arg.output, config['DEFAULTS']['FILE_LOG_COWRIE']))

    logger = get_logger(arg.verbose)

    logger.info('Start Parser')
    start = timer()
    parser = Parser(logger, arg.output, arg.dir, 'DEFAULTS')
    parser.parse(arg.mmdb)

    logger.info('Start Complete Sessions')
    c = CompleteSession(logger, arg.output, 'DEFAULTS')
    c.run()

    logger.info('Start JSON Compatible')
    comp = Compatible(logger, arg.output, 'DEFAULTS')
    comp.run()
    end = timer()
    logger.info('Time total: {}'.format(end - start))  # Time in seconds

    # Eliminacion de ficheros auxiliares imnecesarios
    os.remove('{}/{}'.format(arg.output, config['DEFAULTS']['FILE_LOG_COMPLETED']))
    os.remove('{}/{}'.format(arg.output, config['DEFAULTS']['FILE_LOG_SESSION']))
    os.remove('{}/{}'.format(arg.output, config['DEFAULTS']['FILE_LOG_NOSESSION']))
